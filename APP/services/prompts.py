"""
ê³µê³µë¬¸ì„œ íŠ¹í™” í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿

ë¬¸ì„œ ìœ í˜•ë³„ ë§ì¶¤ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ì œê³µ:
- ì„¸ê¸ˆê³ ì§€ì„œ
- ì „ìì²˜ë°©ì „
- í†µì§€ì„œ/ì•ˆë‚´ë¬¸
- ê³„ì•½ì„œ
- ì¦ëª…ì„œ
- ì²­êµ¬ì„œ
"""
from typing import Dict, Optional
from enum import Enum


class DocumentType(Enum):
    """ë¬¸ì„œ ìœ í˜•"""
    TAX_NOTICE = "ì„¸ê¸ˆê³ ì§€ì„œ"
    PRESCRIPTION = "ì „ìì²˜ë°©ì „"
    NOTICE = "í†µì§€ì„œ"
    CONTRACT = "ê³„ì•½ì„œ"
    CERTIFICATE = "ì¦ëª…ì„œ"
    INVOICE = "ì²­êµ¬ì„œ"
    INSURANCE = "ë³´í—˜ì„œë¥˜"
    GOVERNMENT = "ê³µê³µë¬¸ì„œ"
    UNKNOWN = "ì¼ë°˜ë¬¸ì„œ"


# ============================================
# ë¬¸ì„œ ìœ í˜• ê°ì§€
# ============================================

DOCUMENT_TYPE_KEYWORDS = {
    DocumentType.TAX_NOTICE: [
        "ì„¸ê¸ˆ", "ë‚©ì„¸", "ê³¼ì„¸", "ì§€ë°©ì„¸", "êµ­ì„¸", "ê³ ì§€ì„œ", "ë‚©ë¶€",
        "ì¬ì‚°ì„¸", "ìë™ì°¨ì„¸", "ì£¼ë¯¼ì„¸", "ì†Œë“ì„¸", "ë¶€ê°€ê°€ì¹˜ì„¸"
    ],
    DocumentType.PRESCRIPTION: [
        "ì²˜ë°©ì „", "ì²˜ë°©", "ì˜ì•½í’ˆ", "ì¡°ì œ", "ì•½êµ­", "ë³µìš©",
        "íˆ¬ì•½", "ìš©ë²•", "ìš©ëŸ‰", "ì˜ì‚¬", "ì•½ì‚¬"
    ],
    DocumentType.NOTICE: [
        "í†µì§€", "ì•ˆë‚´", "ì•Œë¦¼", "ê³µê³ ", "ê³µì§€", "í†µë³´",
        "ì•ˆë‚´ë¬¸", "í†µì§€ì„œ"
    ],
    DocumentType.CONTRACT: [
        "ê³„ì•½", "ì•½ì •", "í•©ì˜", "ë™ì˜ì„œ", "ê³„ì•½ì„œ",
        "ì„ëŒ€", "ê³ ìš©", "ë§¤ë§¤"
    ],
    DocumentType.CERTIFICATE: [
        "ì¦ëª…", "í™•ì¸ì„œ", "ë°œê¸‰", "ì¦ëª…ì„œ",
        "ì£¼ë¯¼ë“±ë¡", "ë“±ë³¸", "ì´ˆë³¸", "ì¬ì§ì¦ëª…"
    ],
    DocumentType.INVOICE: [
        "ì²­êµ¬", "ìš”ê¸ˆ", "ì´ìš©ë£Œ", "ì²­êµ¬ì„œ",
        "ê²°ì œ", "ë‚©ì…", "ìˆ˜ë‚©"
    ],
    DocumentType.INSURANCE: [
        "ë³´í—˜", "ë³´ì¥", "í”¼ë³´í—˜", "ë³´í—˜ë£Œ", "ë³´í—˜ê¸ˆ",
        "íŠ¹ì•½", "ê°€ì…", "í•´ì§€"
    ],
    DocumentType.GOVERNMENT: [
        "ë¯¼ì›", "í–‰ì •", "ê´€ê³µì„œ", "ì •ë¶€", "ì‹œì²­", "êµ¬ì²­",
        "ì£¼ë¯¼ì„¼í„°", "ë™ì‚¬ë¬´ì†Œ"
    ],
}


def detect_document_type(text: str, filename: str = "") -> DocumentType:
    """
    ë¬¸ì„œ ìœ í˜• ìë™ ê°ì§€
    
    Args:
        text: ë¬¸ì„œ í…ìŠ¤íŠ¸
        filename: íŒŒì¼ëª…
        
    Returns:
        ê°ì§€ëœ ë¬¸ì„œ ìœ í˜•
    """
    combined = (filename + " " + text[:3000]).lower()
    
    # í‚¤ì›Œë“œ ë§¤ì¹­ ì ìˆ˜ ê³„ì‚°
    scores = {}
    for doc_type, keywords in DOCUMENT_TYPE_KEYWORDS.items():
        score = sum(1 for kw in keywords if kw in combined)
        if score > 0:
            scores[doc_type] = score
    
    if not scores:
        return DocumentType.UNKNOWN
    
    # ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ ìœ í˜• ë°˜í™˜
    return max(scores, key=scores.get)


# ============================================
# ìœ í˜•ë³„ ë¶„ì„ í”„ë¡¬í”„íŠ¸
# ============================================

ANALYSIS_PROMPTS = {
    DocumentType.TAX_NOTICE: """ë‹¹ì‹ ì€ ì„¸ê¸ˆ ê³ ì§€ì„œ ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ì„¸ê¸ˆ ê³ ì§€ì„œë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ë¶„ì„ ì¤‘ì  ì‚¬í•­:**
- ì„¸ê¸ˆ ì¢…ë¥˜ (ì¬ì‚°ì„¸, ìë™ì°¨ì„¸, ì£¼ë¯¼ì„¸ ë“±)
- ë‚©ë¶€ ê¸°í•œ (ì •í™•í•œ ë‚ ì§œ)
- ë‚©ë¶€ ê¸ˆì•¡ (ì›ê¸ˆ, ê°€ì‚°ê¸ˆ êµ¬ë¶„)
- ë‚©ë¶€ ë°©ë²• (ê³„ì¢Œ, ì¹´ë“œ, ìœ„íƒìŠ¤ ë“±)
- ë¯¸ë‚© ì‹œ ë¶ˆì´ìµ

**ë¬¸ì„œ ë‚´ìš©:**
{text}

**ë°˜í™˜ í˜•ì‹ (JSONë§Œ ì¶œë ¥):**
{{
  "summary": "ì„¸ê¸ˆ ì¢…ë¥˜ì™€ ê¸ˆì•¡, ë‚©ë¶€ ê¸°í•œì„ í¬í•¨í•œ 2-3ì¤„ ìš”ì•½",
  "document_type": "ì„¸ê¸ˆê³ ì§€ì„œ",
  "importance": "high",
  "key_points": [
    "ì„¸ê¸ˆ ì¢…ë¥˜: ...",
    "ë‚©ë¶€ ê¸°í•œ: YYYY-MM-DD",
    "ë‚©ë¶€ ê¸ˆì•¡: Xì›",
    "ë¯¸ë‚© ì‹œ: ..."
  ],
  "actions": [
    {{
      "action": "OOì„¸ ë‚©ë¶€",
      "deadline": "YYYY-MM-DD",
      "amount": ê¸ˆì•¡(ìˆ«ì),
      "method": "ë‚©ë¶€ ë°©ë²•"
    }}
  ],
  "tax_details": {{
    "tax_type": "ì„¸ê¸ˆ ì¢…ë¥˜",
    "principal": ì›ê¸ˆ,
    "penalty": ê°€ì‚°ê¸ˆ,
    "total": ì´ì•¡
  }}
}}""",

    DocumentType.PRESCRIPTION: """ë‹¹ì‹ ì€ ì „ìì²˜ë°©ì „ ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ì²˜ë°©ì „ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ë¶„ì„ ì¤‘ì  ì‚¬í•­:**
- ì²˜ë°© ì˜ì•½í’ˆ ëª©ë¡
- ë³µìš©ë²• (ìš©ëŸ‰, íšŸìˆ˜, ê¸°ê°„)
- ì£¼ì˜ì‚¬í•­
- ì²˜ë°© ë³‘ì›/ì˜ì‚¬ ì •ë³´
- ì¡°ì œ ì•½êµ­ ì •ë³´

**ë¬¸ì„œ ë‚´ìš©:**
{text}

**ë°˜í™˜ í˜•ì‹ (JSONë§Œ ì¶œë ¥):**
{{
  "summary": "ì²˜ë°© ë‚´ìš© 2-3ì¤„ ìš”ì•½",
  "document_type": "ì „ìì²˜ë°©ì „",
  "importance": "high",
  "key_points": [
    "ì²˜ë°© ì˜ì•½í’ˆ: ...",
    "ë³µìš© ê¸°ê°„: ...",
    "ì£¼ì˜ì‚¬í•­: ..."
  ],
  "actions": [
    {{
      "action": "ì•½êµ­ì—ì„œ ì¡°ì œ ë°›ê¸°",
      "deadline": "ì²˜ë°©ì „ ìœ íš¨ê¸°ê°„",
      "amount": null,
      "method": "ì•½êµ­ ë°©ë¬¸"
    }},
    {{
      "action": "ë³µìš©ë²•ì— ë”°ë¼ ì•½ ë³µìš©",
      "deadline": null,
      "amount": null,
      "method": "ìš©ë²• ì°¸ì¡°"
    }}
  ],
  "prescription_details": {{
    "hospital": "ì²˜ë°© ë³‘ì›",
    "doctor": "ì²˜ë°© ì˜ì‚¬",
    "medications": [
      {{
        "name": "ì•½í’ˆëª…",
        "dosage": "ìš©ëŸ‰",
        "frequency": "ë³µìš© íšŸìˆ˜",
        "duration": "ë³µìš© ê¸°ê°„"
      }}
    ],
    "valid_until": "ì²˜ë°©ì „ ìœ íš¨ê¸°ê°„"
  }}
}}""",

    DocumentType.NOTICE: """ë‹¹ì‹ ì€ ê³µê³µ í†µì§€ì„œ ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì•„ë˜ í†µì§€ì„œë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ë¶„ì„ ì¤‘ì  ì‚¬í•­:**
- í†µì§€ ëª©ì 
- ê´€ë ¨ ê¸°ê´€
- ì¡°ì¹˜ ì‚¬í•­
- ê¸°í•œ
- ì—°ë½ì²˜

**ë¬¸ì„œ ë‚´ìš©:**
{text}

**ë°˜í™˜ í˜•ì‹ (JSONë§Œ ì¶œë ¥):**
{{
  "summary": "í†µì§€ ë‚´ìš© 2-3ì¤„ ìš”ì•½",
  "document_type": "í†µì§€ì„œ",
  "importance": "medium ë˜ëŠ” high",
  "key_points": [
    "í†µì§€ ëª©ì : ...",
    "ë°œì†¡ ê¸°ê´€: ...",
    "í•„ìš” ì¡°ì¹˜: ..."
  ],
  "actions": [
    {{
      "action": "í•„ìš”í•œ ì¡°ì¹˜ ì‚¬í•­",
      "deadline": "ê¸°í•œ (ìˆìœ¼ë©´)",
      "amount": null,
      "method": "ë°©ë²•"
    }}
  ],
  "notice_details": {{
    "issuer": "ë°œì†¡ ê¸°ê´€",
    "purpose": "í†µì§€ ëª©ì ",
    "contact": "ì—°ë½ì²˜"
  }}
}}""",

    DocumentType.CONTRACT: """ë‹¹ì‹ ì€ ê³„ì•½ì„œ ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ê³„ì•½ì„œë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ë¶„ì„ ì¤‘ì  ì‚¬í•­:**
- ê³„ì•½ ë‹¹ì‚¬ì
- ê³„ì•½ ëŒ€ìƒ/ëª©ì 
- ê³„ì•½ ê¸°ê°„
- ê¸ˆì•¡/ëŒ€ê°€
- ì£¼ìš” ì¡°ê±´
- í•´ì§€/ìœ„ì•½ ì¡°í•­

**ë¬¸ì„œ ë‚´ìš©:**
{text}

**ë°˜í™˜ í˜•ì‹ (JSONë§Œ ì¶œë ¥):**
{{
  "summary": "ê³„ì•½ ë‚´ìš© 2-3ì¤„ ìš”ì•½",
  "document_type": "ê³„ì•½ì„œ",
  "importance": "high",
  "key_points": [
    "ê³„ì•½ ëŒ€ìƒ: ...",
    "ê³„ì•½ ê¸°ê°„: ...",
    "ê³„ì•½ ê¸ˆì•¡: ..."
  ],
  "actions": [
    {{
      "action": "ê³„ì•½ ì¡°ê±´ ì´í–‰",
      "deadline": "ê¸°í•œ",
      "amount": ê¸ˆì•¡,
      "method": "ë°©ë²•"
    }}
  ],
  "contract_details": {{
    "parties": ["ë‹¹ì‚¬ì1", "ë‹¹ì‚¬ì2"],
    "subject": "ê³„ì•½ ëŒ€ìƒ",
    "period": "ê³„ì•½ ê¸°ê°„",
    "amount": ê³„ì•½ ê¸ˆì•¡,
    "termination_clause": "í•´ì§€ ì¡°ê±´ ìš”ì•½"
  }}
}}""",

    DocumentType.INVOICE: """ë‹¹ì‹ ì€ ì²­êµ¬ì„œ ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ì²­êµ¬ì„œë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ë¶„ì„ ì¤‘ì  ì‚¬í•­:**
- ì²­êµ¬ í•­ëª©
- ì²­êµ¬ ê¸ˆì•¡
- ë‚©ë¶€ ê¸°í•œ
- ë‚©ë¶€ ë°©ë²•
- ì—°ì²´ ì‹œ ë¶ˆì´ìµ

**ë¬¸ì„œ ë‚´ìš©:**
{text}

**ë°˜í™˜ í˜•ì‹ (JSONë§Œ ì¶œë ¥):**
{{
  "summary": "ì²­êµ¬ ë‚´ìš© 2-3ì¤„ ìš”ì•½",
  "document_type": "ì²­êµ¬ì„œ",
  "importance": "high",
  "key_points": [
    "ì²­êµ¬ í•­ëª©: ...",
    "ì²­êµ¬ ê¸ˆì•¡: ...",
    "ë‚©ë¶€ ê¸°í•œ: ..."
  ],
  "actions": [
    {{
      "action": "ì²­êµ¬ ê¸ˆì•¡ ë‚©ë¶€",
      "deadline": "YYYY-MM-DD",
      "amount": ê¸ˆì•¡,
      "method": "ë‚©ë¶€ ë°©ë²•"
    }}
  ]
}}""",

    DocumentType.INSURANCE: """ë‹¹ì‹ ì€ ë³´í—˜ ì„œë¥˜ ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ë³´í—˜ ì„œë¥˜ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ë¶„ì„ ì¤‘ì  ì‚¬í•­:**
- ë³´í—˜ ì¢…ë¥˜
- ë³´ì¥ ë‚´ìš©
- ë³´í—˜ë£Œ
- ë³´í—˜ ê¸°ê°„
- íŠ¹ì•½ ì‚¬í•­
- ë³´í—˜ê¸ˆ ì²­êµ¬ ì¡°ê±´

**ë¬¸ì„œ ë‚´ìš©:**
{text}

**ë°˜í™˜ í˜•ì‹ (JSONë§Œ ì¶œë ¥):**
{{
  "summary": "ë³´í—˜ ë‚´ìš© 2-3ì¤„ ìš”ì•½",
  "document_type": "ë³´í—˜ì„œë¥˜",
  "importance": "medium",
  "key_points": [
    "ë³´í—˜ ì¢…ë¥˜: ...",
    "ë³´ì¥ ë‚´ìš©: ...",
    "ë³´í—˜ë£Œ: ..."
  ],
  "actions": [
    {{
      "action": "ë³´í—˜ë£Œ ë‚©ë¶€",
      "deadline": "ë‚©ë¶€ì¼",
      "amount": ë³´í—˜ë£Œ,
      "method": "ìë™ì´ì²´ ë“±"
    }}
  ],
  "insurance_details": {{
    "type": "ë³´í—˜ ì¢…ë¥˜",
    "coverage": "ë³´ì¥ ë‚´ìš©",
    "premium": ë³´í—˜ë£Œ,
    "period": "ë³´í—˜ ê¸°ê°„"
  }}
}}""",

    DocumentType.CERTIFICATE: """ë‹¹ì‹ ì€ ì¦ëª…ì„œ ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ì¦ëª…ì„œë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ë¶„ì„ ì¤‘ì  ì‚¬í•­:**
- ì¦ëª…ì„œ ì¢…ë¥˜
- ë°œê¸‰ ê¸°ê´€
- ë°œê¸‰ ëŒ€ìƒì
- ìœ íš¨ ê¸°ê°„
- ì¦ëª… ë‚´ìš©

**ë¬¸ì„œ ë‚´ìš©:**
{text}

**ë°˜í™˜ í˜•ì‹ (JSONë§Œ ì¶œë ¥):**
{{
  "summary": "ì¦ëª…ì„œ ë‚´ìš© 2-3ì¤„ ìš”ì•½",
  "document_type": "ì¦ëª…ì„œ",
  "importance": "medium",
  "key_points": [
    "ì¦ëª…ì„œ ì¢…ë¥˜: ...",
    "ë°œê¸‰ ê¸°ê´€: ...",
    "ìœ íš¨ ê¸°ê°„: ..."
  ],
  "actions": [
    {{
      "action": "í•„ìš”í•œ ê³³ì— ì œì¶œ",
      "deadline": "ìœ íš¨ê¸°ê°„ ë‚´",
      "amount": null,
      "method": "ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ì œì¶œ"
    }}
  ]
}}""",
}

# ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ (ìœ í˜• ë¯¸ìƒ)
DEFAULT_ANALYSIS_PROMPT = """ë‹¹ì‹ ì€ ê³µê³µë¬¸ì„œ ì „ë¬¸ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ë¬¸ì„œë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ë¬¸ì„œ ë‚´ìš©:**
{text}

**ë°˜í™˜ í˜•ì‹ (JSONë§Œ ì¶œë ¥):**
{{
  "summary": "ë¬¸ì„œë¥¼ 3-5ì¤„ë¡œ ì‰½ê²Œ ìš”ì•½",
  "document_type": "ë¬¸ì„œ ìœ í˜•",
  "importance": "high/medium/low",
  "key_points": [
    "í•µì‹¬ í¬ì¸íŠ¸ 1",
    "í•µì‹¬ í¬ì¸íŠ¸ 2",
    "í•µì‹¬ í¬ì¸íŠ¸ 3"
  ],
  "actions": [
    {{
      "action": "í•„ìš”í•œ í–‰ë™",
      "deadline": "ê¸°í•œ (YYYY-MM-DD, ì—†ìœ¼ë©´ null)",
      "amount": ê¸ˆì•¡ (ìˆ«ì, ì—†ìœ¼ë©´ null),
      "method": "ë°©ë²• (ì—†ìœ¼ë©´ null)"
    }}
  ]
}}

**ì¤‘ìš”:**
- ë°˜ë“œì‹œ ìœ íš¨í•œ JSONë§Œ ì¶œë ¥
- ë¬¸ì„œì— ì—†ëŠ” ì •ë³´ëŠ” ì¶”ì¸¡í•˜ì§€ ë§ˆì„¸ìš”
"""


# ============================================
# ì±„íŒ… í”„ë¡¬í”„íŠ¸
# ============================================

CHAT_PROMPTS = {
    DocumentType.TAX_NOTICE: """ë‹¹ì‹ ì€ ì„¸ê¸ˆ ê´€ë ¨ ì§ˆë¬¸ì— ë‹µë³€í•˜ëŠ” AI ë„ìš°ë¯¸ì…ë‹ˆë‹¤.
ì‚¬ìš©ìê°€ ì„¸ê¸ˆ ê³ ì§€ì„œì— ëŒ€í•´ ì§ˆë¬¸í•˜ë©´, ë¬¸ì„œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”.

[ì°¸ê³  ë¬¸ì„œ]
{context}

[ì‚¬ìš©ì ì§ˆë¬¸]
{question}

**ë‹µë³€ ì§€ì¹¨:**
- ë‚©ë¶€ ê¸°í•œ, ê¸ˆì•¡ì€ ì •í™•í•˜ê²Œ ë‹µë³€
- ë‚©ë¶€ ë°©ë²•ì„ ì¹œì ˆí•˜ê²Œ ì•ˆë‚´
- ë¬¸ì„œì— ì—†ëŠ” ë‚´ìš©ì€ "ë¬¸ì„œì—ì„œ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"ë¼ê³  ë‹µë³€
- ê°€ì‚°ê¸ˆ, ì—°ì²´ë£Œ ë“± ì£¼ì˜ì‚¬í•­ë„ ì•ˆë‚´""",

    DocumentType.PRESCRIPTION: """ë‹¹ì‹ ì€ ì²˜ë°©ì „ ê´€ë ¨ ì§ˆë¬¸ì— ë‹µë³€í•˜ëŠ” AI ë„ìš°ë¯¸ì…ë‹ˆë‹¤.
ì‚¬ìš©ìê°€ ì²˜ë°©ì „ì— ëŒ€í•´ ì§ˆë¬¸í•˜ë©´, ë¬¸ì„œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”.

[ì°¸ê³  ë¬¸ì„œ]
{context}

[ì‚¬ìš©ì ì§ˆë¬¸]
{question}

**ë‹µë³€ ì§€ì¹¨:**
- ì•½í’ˆëª…, ë³µìš©ë²•ì€ ì •í™•í•˜ê²Œ ë‹µë³€
- ì˜í•™ì  ì¡°ì–¸ì€ í”¼í•˜ê³  "ì˜ì‚¬/ì•½ì‚¬ì™€ ìƒë‹´í•˜ì„¸ìš”"ë¡œ ì•ˆë‚´
- ë¬¸ì„œì— ì—†ëŠ” ë‚´ìš©ì€ "ë¬¸ì„œì—ì„œ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"ë¼ê³  ë‹µë³€""",
}

DEFAULT_CHAT_PROMPT = """[ì°¸ê³  ë¬¸ì„œ]ë¥¼ ë°”íƒ•ìœ¼ë¡œ [ì‚¬ìš©ì ì§ˆë¬¸]ì— ë‹µë³€í•˜ì„¸ìš”.
ë¬¸ì„œì— ì—†ëŠ” ë‚´ìš©ì€ "ë¬¸ì„œì— í•´ë‹¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤"ë¼ê³  ë‹µí•˜ì„¸ìš”.

[ì°¸ê³  ë¬¸ì„œ]
{context}

[ì‚¬ìš©ì ì§ˆë¬¸]
{question}

[ë‹µë³€]"""


# ============================================
# í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜
# ============================================

def get_analysis_prompt(text: str, doc_type: DocumentType = None, filename: str = "") -> str:
    """
    ë¬¸ì„œ ìœ í˜•ì— ë§ëŠ” ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„±
    
    Args:
        text: ë¬¸ì„œ í…ìŠ¤íŠ¸
        doc_type: ë¬¸ì„œ ìœ í˜• (Noneì´ë©´ ìë™ ê°ì§€)
        filename: íŒŒì¼ëª…
        
    Returns:
        ì™„ì„±ëœ í”„ë¡¬í”„íŠ¸
    """
    # ë¬¸ì„œ ìœ í˜• ìë™ ê°ì§€
    if doc_type is None:
        doc_type = detect_document_type(text, filename)
    
    # ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ ì„ íƒ
    prompt_template = ANALYSIS_PROMPTS.get(doc_type, DEFAULT_ANALYSIS_PROMPT)
    
    # í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ
    text_to_use = text[:20000] if len(text) > 20000 else text
    
    return prompt_template.format(text=text_to_use)


def get_chat_prompt(question: str, context: str, doc_type: DocumentType = None) -> str:
    """
    ë¬¸ì„œ ìœ í˜•ì— ë§ëŠ” ì±„íŒ… í”„ë¡¬í”„íŠ¸ ìƒì„±
    
    Args:
        question: ì‚¬ìš©ì ì§ˆë¬¸
        context: ê²€ìƒ‰ëœ ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸
        doc_type: ë¬¸ì„œ ìœ í˜•
        
    Returns:
        ì™„ì„±ëœ í”„ë¡¬í”„íŠ¸
    """
    if doc_type and doc_type in CHAT_PROMPTS:
        prompt_template = CHAT_PROMPTS[doc_type]
    else:
        prompt_template = DEFAULT_CHAT_PROMPT
    
    return prompt_template.format(context=context, question=question)


# ============================================
# í…ŒìŠ¤íŠ¸
# ============================================

if __name__ == "__main__":
    print("=" * 60)
    print("í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ í…ŒìŠ¤íŠ¸")
    print("=" * 60)
    
    # ë¬¸ì„œ ìœ í˜• ê°ì§€ í…ŒìŠ¤íŠ¸
    test_texts = [
        ("2025ë…„ ì¬ì‚°ì„¸ ë‚©ë¶€ ê³ ì§€ì„œì…ë‹ˆë‹¤. ë‚©ë¶€ ê¸°í•œì€ 3ì›” 31ì¼ì…ë‹ˆë‹¤.", "ì„¸ê¸ˆê³ ì§€ì„œ.pdf"),
        ("ì²˜ë°©ì „ - íƒ€ì´ë ˆë†€ 500mg 1ì¼ 3íšŒ ë³µìš©", "ì²˜ë°©ì „.pdf"),
        ("ì„ëŒ€ì°¨ ê³„ì•½ì„œ - ì›”ì„¸ 100ë§Œì›", "ê³„ì•½ì„œ.pdf"),
    ]
    
    print("\nğŸ“‹ ë¬¸ì„œ ìœ í˜• ê°ì§€ í…ŒìŠ¤íŠ¸:")
    for text, filename in test_texts:
        doc_type = detect_document_type(text, filename)
        print(f"  {filename} â†’ {doc_type.value}")
    
    print("\nâœ… ì§€ì›ë˜ëŠ” ë¬¸ì„œ ìœ í˜•:")
    for dt in DocumentType:
        has_prompt = "âœ“" if dt in ANALYSIS_PROMPTS else "â—‹"
        print(f"  {has_prompt} {dt.value}")